name: Deploy Laravel Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ADMIN_FIRST_NAME: ${{ vars.ADMIN_FIRST_NAME }}
      ADMIN_LAST_NAME: ${{ vars.ADMIN_LAST_NAME }}
      ADMIN_EMAIL: ${{ vars.ADMIN_EMAIL }}
      ADMIN_NICKNAME: ${{ vars.ADMIN_NICKNAME }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:
    - name: Set environment-specific variables
      run: |
        if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
          echo "APP_ENV=staging" >> $GITHUB_ENV
          echo "APP_URL=${{ secrets.STAGING_APP_URL }}" >> $GITHUB_ENV
          echo "DB_DATABASE=${{ secrets.STAGING_DB_DATABASE }}" >> $GITHUB_ENV
          echo "DB_USERNAME=${{ secrets.STAGING_DB_USERNAME }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DEPLOYPATH=/home/schnupf1/staging" >> $GITHUB_ENV
        elif [ "${{ github.event.inputs.environment }}" == "production" ]; then
          echo "APP_ENV=production" >> $GITHUB_ENV
          echo "APP_URL=${{ secrets.PRODUCTION_APP_URL }}" >> $GITHUB_ENV
          echo "DB_DATABASE=${{ secrets.PRODUCTION_DB_DATABASE }}" >> $GITHUB_ENV
          echo "DB_USERNAME=${{ secrets.PRODUCTION_DB_USERNAME }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.PRODUCTION_DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DEPLOYPATH=/home/schnupf1/production" >> $GITHUB_ENV
        fi

    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, intl, pdo, pdo_mysql
        tools: composer

    - name: Install Composer dependencies
      run: composer install --no-progress --no-interaction --prefer-dist --optimize-autoloader

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install Node.js dependencies
      run: yarn install

    - name: Build assets
      run: yarn build

    - name: Prepare environment file
      run: |
        cp .env.example .env
        sed -i 's/^APP_ENV=.*/APP_ENV=${{ env.APP_ENV }}/' .env
        sed -i 's/^APP_URL=.*/APP_URL=${{ env.APP_URL }}/' .env
        sed -i 's/^DB_DATABASE=.*/DB_DATABASE=${{ env.DB_DATABASE }}/' .env
        sed -i 's/^DB_USERNAME=.*/DB_USERNAME=${{ env.DB_USERNAME }}/' .env
        sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=${{ env.DB_PASSWORD }}/' .env
        sed -i 's/^ADMIN_FIRST_NAME=.*/ADMIN_FIRST_NAME=${{ env.ADMIN_FIRST_NAME }}/' .env
        sed -i 's/^ADMIN_LAST_NAME=.*/ADMIN_LAST_NAME=${{ env.ADMIN_LAST_NAME }}/' .env
        sed -i 's/^ADMIN_EMAIL=.*/ADMIN_EMAIL=${{ env.ADMIN_EMAIL }}/' .env
        sed -i 's/^ADMIN_NICKNAME=.*/ADMIN_NICKNAME=${{ env.ADMIN_NICKNAME }}/' .env
        sed -i 's/^ADMIN_PASSWORD=.*/ADMIN_PASSWORD="${{ env.ADMIN_PASSWORD }}"/' .env

    - name: Log environment variables
      run: |
        echo "Environment variables:"
        cat .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts

    - name: Sync application files to the server
      run: |
        rsync -avz --delete-after --exclude='.git' --exclude='.github' --exclude='tests' --exclude='storage' $GITHUB_WORKSPACE/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }}:${{ env.DEPLOYPATH }}

    - name: Clean up directories on the server
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} << EOF
          set -e
          cd $DEPLOYPATH
          rm -rf vendor
          rm -rf node_modules
          rm -rf public/build
        EOF

    - name: Create symlink and set permissions on the server
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} << EOF
          set -e
          ln -sfn $DEPLOYPATH /home/schnupf1/www/${{ env.APP_ENV }}
          chmod 755 $DEPLOYPATH
        EOF

    - name: Ensure storage and cache directories exist and have proper permissions
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} << EOF
          set -e
          cd $DEPLOYPATH
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p bootstrap/cache
          chmod -R 755 storage
          chmod -R 755 bootstrap/cache
        EOF

    - name: Run database migrations and optimizations on the server
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} << EOF
          set -e
          cd $DEPLOYPATH
          /opt/cpanel/ea-php82/root/usr/bin/php artisan migrate:refresh --seed
          /opt/cpanel/ea-php82/root/usr/bin/php artisan optimize
          /opt/cpanel/ea-php82/root/usr/bin/php artisan config:cache
          /opt/cpanel/ea-php82/root/usr/bin/php artisan event:cache
          /opt/cpanel/ea-php82/root/usr/bin/php artisan route:cache
          /opt/cpanel/ea-php82/root/usr/bin/php artisan view:cache
        EOF

    - name: Verify application setup
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} << EOF
          set -e
          cd $DEPLOYPATH
          php artisan --version
          php -m
          php -i
        EOF
